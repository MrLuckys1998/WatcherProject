"""
Watcher: custom_query
Descripción: Ejecuta una consulta personalizada definida completamente por el usuario.
Parámetros esperados:
- index: Índice de Elasticsearch
- query: Objeto completo de la query
- condition_script: Código Python que evalúa si se dispara la alerta
- elastic_url, elastic_user, elastic_pass
"""

from elasticsearch import Elasticsearch
from datetime import datetime
from logger import logger

def run():
    es = Elasticsearch("{{ elastic_url }}", basic_auth=(
        "{{ elastic_user }}", "{{ elastic_pass }}"), verify_certs=False)

    result = es.search(index="{{ index }}", body={{ query | tojson }})
    logger.info("Consulta ejecutada")

    # Evaluación personalizada por el usuario
    try:
        {{ condition_script }}
    except Exception as e:
        logger.error(f"Error evaluando condición: {e}")